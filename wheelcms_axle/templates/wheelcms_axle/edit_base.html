{# base template that includes editing controls #}
{% extends "wheelcms_axle/base.html" %}

{% block javascript %}

{{ block.super }}

<script src="/static/js/upload/jquery.ui.widget.js"></script>
<script src="/static/js/upload/jquery.iframe-transport.js"></script>
<script src="/static/js/upload/jquery.fileupload.js"></script>

<script type="text/javascript" charset="utf-8">
    function bt_stack_fix() {
        /*
         * https://github.com/twitter/bootstrap/issues/4781
         * http://stackoverflow.com/questions/13649459/twitter-bootstrap-multiple-modal-error
         */
        $(document).off('focusin.modal');
    }

    var upload_modal = (function() {
        var mode = "any";
        var url = "";
        var callback = null;

        function load_form(url, type) {
            /*
             * Used by the upload modal: load the remote upload form, it can
             * be different depending on the context.
             */
            if(url == '/') {
                url = '';
            }
            var data = $.ajax({
                url: url + '/fileup?type=' + type,
                dataType:"json",
                async: false
                }).responseText;
            data = $.parseJSON(data);
            var form = data.form;
            $(".uploadform").html(form);

            $('#fileupload').fileupload({
                dataType: 'json',
                url: url + '/fileup',
                done: function (e, data) {
                    if(data.result.status == "ok") {
                      $("#uploadModal").modal("hide");

                      var path = data.result.path;
                      if(callback) {
                        callback(path);
                      }
                    }
                    else {
                        // if anything went wrong, it must have been with the uploaded file
                        $(".upload-alert").text(data.result.errors.storage);
                        $(".upload-alert").addClass("alert");
                    }
                // fail, .. http://api.jquery.com/Types/#Promise
                }
            });
        }

        return function(_url, _mode, _callback) {
            /*
             * Open the upload modal. url is where the content will be uploaded
             * to, mode determines what content can be uploaded:
             * - "any" means images and files
             * - "image" means only images
             */
            mode = _mode;
            url = _url;
            callback = _callback;

            var header = $("#uploadModalLabel");
            var types = $(".upload_types");

            /* XXX
             * The uploadable types should be much more dynamic - we may/will
             * eventually support different types of files and images from
             * which you can chose.
             */
            if(mode == "any") {
                header.text("Upload content");
                types.html('<select class="select_type"> ' +
                           '<option value="image">an Image</option> ' +
                           '<option value="file">a File</option> ' +
                           '</select>');
            } else {
                header.text("Upload an image");
                types.html('<select class="select_type"> ' +
                           '<option value="image">an Image</option> ' +
                           '</select>');
            }
            $("#uploadModal").modal();
            $(".upload-alert").empty();
            $(".upload-alert").removeClass("alert");
            bt_stack_fix();
            load_form(url, $(".select_type").val());
            $(".select_type").change(function() {
                load_form(url, $(this).val());
            });
            return false;
        }
    })();

    var wheel_browser = (function() {
        var _browser;
        var current_path = '';
        var mode = "link";
        var callback = null;
        var initialized = false;

        function fix_sizes() {
            /*
             * Make sure the "panels" div takes up exactly the remaining space.
             * Can this be done in css? XXX
             */
            var total = $("#browseModal .modal-body").height();
            var header = $("#browsecrumbs").outerHeight(true);
            var tabs = $("#browseModal .nav-tabs").outerHeight(true);
            var remainder = total - header - tabs;
            $("#panels").height(remainder);
        }
        function load_panels(path, panelid) {
                /*
                 * How should the shifting of panels behave? Currently, if possible,
                 * all three columns are used. This may mean that clicking in the first
                 * colum will move the first panel to the second position. But this
                 * doesn't have to be bad - it's a nice way to access the parent
                 */
                current_path = path;
                var data = $.ajax({
                    url: '/panel?path='+encodeURIComponent(path) + "&mode="+mode,
                    dataType:"json",
                    async: false
                    }).responseText;
                data = $.parseJSON(data);
                var panels = data.panels;
                var crumbs = data.crumbs;

                var path = data.path;

                var idx = 0;
                for(var i= 0; i < 3; i++) {
                    $(".panel" + i).empty();
                }

                for(var i=0; i < panels.length; i++) {
                    var paneldata = panels[i];
                    var panel = $(".panel" + i);
                    panel.html(paneldata);
                }
                $(".crumbcontainer").html(crumbs);
                setTimeout(fix_sizes, 250);
                // find the current selection and see if it's selectable
                select_state($("tr[data-url='" + path + "']").data("selectable") == "yes");
        }

        function select_state(enabled) {
            /* enable/disable the 'Select' button */
            var selectbutton = $("#browseModal .modal_select");

            if(enabled) {
                selectbutton.removeAttr("disabled");
            }
            else {
                selectbutton.attr("disabled", "disabled");
            }
        }

        function init(_mode, _callback) {
            mode = _mode;
            callback = _callback;
            /*
             * Initialize handlers, set title
             */
            var header = $("#browseModalLabel");
            if(mode == "link") {
                header.text("Select content to link to");
            } else {
                header.text("Select an image to insert");
            }

            select_state(false);

            if(initialized) {
                return;
            }
            initialized = true;
            // stuff from here on only should be initialized once

            $(".modal_select").click(function() {
                if(callback) {
                    callback(current_path);
                }
                _browser.modal('hide');
            });

            /*
             * cliking an entry in a panel should load the subpanel/content
             */
            $("tr.entry").live('click', function() {
                var path = $(this).data('url');
                var panelid = parseInt($(this).parents("div.panel").data('panel'));
                load_panels(path, panelid);
                if($(this).data("selectable") == "yes") {
                    select_state(true);
                }
                else {
                    select_state(false);
                }
                return false;
            });
            /*
             * clicking a path component in the breadcrumb should take you there
             */
            $("a.crumb").live('click', function() {
                var path = $(this).data('url');
                var panelid = parseInt($(this).parents("div.panel").data('panel'));
                load_panels(path, panelid);
                return false;
            });
            /*
             * clicking the upload icon should open the upload modal
             */
            $(".node_upload").live('click', function() {
                var url = $(this).data('url');
                // hide & reopen browse dialog?
                upload_modal(url, mode=="link"?"any":"image", function(path) {
                    // should scroll to selection(s)!
                    load_panels(path, 3);
                });
            });
        }

        return function(path, mode, callback) {
            _browser = $("#browseModal");
            init(mode, callback);
            _browser.modal();
            bt_stack_fix();
            load_panels(path || '', 3);
        }
    })();

</script>

{% endblock %}

{% block base_main %}

<!-- Button to trigger modal -->

<div id="browseModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="browseModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="browseModalLabel">Select a file</h3>
  </div>
  <div class="modal-body tabbable">
    <ul class="nav nav-tabs">
      <li class="active"><a href="#browse_local" data-toggle="tab">Local / Browse</a></li>
      <li class=""><a href="#browse_external_link" data-toggle="tab">External Link</a></li>
      <li class=""><a href="#browse_external_image" data-toggle="tab">External Image</a></li>
    </ul>

    <div class="tab-content">
      <div id="browse_local" class="tab-pane active">
        <div class="row-fluid" id="browsecrumbs">
          <div class="row12 crumbcontainer">
          </div>
        </div>
        <div class="row-fluid" id="panels">
          <div class="span4 panel panel0" data-panel="0" id="panel0">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
          </div>
          <div class="span4 panel panel1" data-panel="1" id="panel1">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
          </div>
          <div class="span4 panel panel2" data-panel="2" id="panel2">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas faucibus dolor at eros consectetur ut consequat enim mollis. Suspendisse ac leo neque, sed suscipit dui. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis ultricies iaculis magna, vel interdum quam volutpat eu. Proin condimentum neque ac tellus adipiscing et tincidunt arcu euismod.
          </div>
        </div>
      </div>
      <div id="browse_external_link" class="tab-pane">
        <div class="row-fluid" id="browsecrumbs">
          <div class="row12">
            External Link
          </div>
        </div>
      </div>
      <div id="browse_external_image" class="tab-pane">
        <div class="row-fluid" id="browsecrumbs">
          <div class="row12">
            External Image
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary modal_select">Select</button>
  </div>
</div>

<div id="uploadModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="uploadModalLabel">Upload a file</h3>
  </div>
  <div class="modal-body">
    <div class="row-fluid">
      <div class="span12 upload-alert">
      </div>
    </div>
    <div class="row-fluid">
      <div class="span12 form-horizontal">
        <div class="control-group">
          <label class="control-label" for="select_type">Upload</label>
          <div class="controls upload_types">
          </div>
        </div>
      </div>
    </div>
    <div class="row-fluid">
      <div class="span12 uploadform">
      </div>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    <button class="btn btn-primary modal_select">Select</button>
  </div>
</div>


{{ block.super }}

{% block base_main_edit %} {# block that automatically includes controls #} {% endblock %}
{% endblock %}
